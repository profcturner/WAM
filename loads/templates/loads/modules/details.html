{% extends "loads/base_automatic.html" %}

{% block content %}

<h4>Details for module {{ module.name }}{% if logged_in_staff and not logged_in_staff.is_external %}<span class="small wam-hide-on-print"><a class="btn btn-sm btn-secondary ms-1" role="button" href="{% url 'update module' module.pk %}">Edit</a></span>{% endif %}</h4>

<div class="mt-4">
    <div class="row mb-2">
        <div class="col-12 col-md-3 fw-bold">
          Module code
        </div>
        <div class="col-9 font-monospace">
            {{ module.module_code }}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-12 col-md-3 fw-bold">
            Module name
        </div>
        <div class="col-9 font-monospace">
            {{ module.module_name }}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-12 col-md-3 fw-bold">
            Module credits
        </div>
        <div class="col-9 font-monospace">
            {{ module.credits }}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-12 col-md-3 fw-bold">
            Module size
        </div>
        <div class="col-9 font-monospace">
            {{ module.size }}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-12 col-md-3 fw-bold">
            Semester
        </div>
        <div class="col-9 font-monospace">
            {{ module.semester }}
        </div>
    </div>
    <div class="row mb-2">
        <div class="col-12 col-md-3 fw-bold">
            Hours
        </div>
        <div class="col-9 font-monospace text-nowrap">
            Total hours: {{ total_hours|stringformat:".2f" }}; Contact hours: {{ contact_hours|stringformat:".2f" }};
            <br/>
            Admin hours {{ admin_hours|stringformat:".2f" }}; Assessment hours {{ assessment_hours|stringformat:".2f" }}
        </div>
    </div>
    {% if module.details %}
    <div class="row mb-2">
        <div class="col-12 col-md-3 fw-bold">
            Other details
        </div>
        <div class="col-9 font-monospace">
            {{ module.details|urlize|linebreaksbr }}
        </div>
    </div>
    {% endif %}
    {% if module.coordinator %}
    <div class="row mb-2">
        <div class="col-12 col-md-3 fw-bold">
            Module coordinator
        </div>
        <div class="col-9 font-monospace">
            {{ module.coordinator }}
        </div>
    </div>
    {% endif %}
    {% if moderators %}
    <div class="row mb-2">
        <div class="col-12 col-md-3 fw-bold">
            Moderators
        </div>
        <div class="col-9 font-monospace">
            {% for moderator in moderators %}{{ moderator }}<br/>{% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<div class="mt-5">
    <h5>Related activity information</h5>
    <p class="mb-3">
        Selected year:<br/>
        <span class="font-monospace fw-bold me-2">{{package}}</span>
    </p>
    {% if package.draft or package.in_the_future or package.in_the_past %}
    <div class="border border-2 border-danger p-3 rounded-3 mb-5">
        <h6 class="fw-bold">!! Please note these exceptions <i class="fw-normal small">(hover for more information)</i></h6>
        <div class="d-flex">
            {% if package.draft %}
            <div class="badge text-bg-danger me-2"
                 title="This is a DRAFT allocation and may be incomplete.">Draft allocation</div>
            {% endif %}
            {% if package.in_the_past %}
            <div class="badge text-bg-danger me-2"
                 title="The currently selected Work Package is in the Past! You probably want to change the year above.">Past work package</div>
            {% endif %}
            {% if package.in_the_future %}
            <div class="badge text-bg-danger me-2"
                 title="The currently selected Work Package is in the Future">Future work package</div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<div class="mt-5">
    <h5>Module staff allocations</h5>
    {% if modulestaff %}
    <div class="table-responsive small mt-2">
        <table class="table table-striped table-hover w-100">
            <thead>
                <tr>
                    <th class="col-7" scope="col">Staff member</th>
                    <th scope="col">Contact proportion</th>
                    <th scope="col">Admin proportion</th>
                    <th scope="col">Assessment proportion</th>
                </tr>
            </thead>
            <tbody class="table-group-divider">
                {% for allocation in modulestaff %}
                <tr>
                    <th class="col-7">{{ allocation.staff }}</th>
                    <td class="font-monospace" style="white-space: pre;">{{ allocation.contact_proportion|stringformat:"6.f" }}%</td>
                    <td class="font-monospace" style="white-space: pre;">{{ allocation.admin_proportion|stringformat:"6.f" }}%</td>
                    <td class="font-monospace" style="white-space: pre;">{{ allocation.assessment_proportion|stringformat:"6.f" }}%</td>
                </tr>
                {% endfor %}
                <tr>
                    <th class="col-7">Total</th>
                    <th style="white-space: pre;" class="font-monospace{% if total_contact_proportion != 100 %} text-bg-danger{% endif %}" {% if total_contact_proportion != 100 %}title="Less than 100%"{% endif %}>{{ total_contact_proportion|stringformat:"6.f" }}%</th>
                    <th style="white-space: pre;" class="font-monospace{% if total_admin_proportion != 100 %} text-bg-danger{% endif %}" {% if total_admin_proportion != 100 %}title="Less than 100%"{% endif %}>{{ total_admin_proportion|stringformat:"6.f" }}%</th>
                    <th style="white-space: pre;" class="font-monospace{% if total_assessment_proportion != 100 %} text-bg-danger{% endif %}" {% if total_assessment_proportion != 100 %}title="Less than 100%"{% endif %}>{{ total_assessment_proportion|stringformat:"6.f" }}%</th>
                </tr>
            </tbody>
        </table>
    </div>
    {% if logged_in_staff and not logged_in_staff.is_external %}
    <p class="wam-hide-on-print">
        <a class="link-opacity-50-hover link-underline-opacity-50 link-offset-2" href="{% url 'module_staff_allocation' package.id module.id %}">Edit allocations</a>
    </p>
    {% endif %}
    {% else %}
    <p>
        <span class="text-info-emphasis">No allocations of staff recorded for this module</span>
        {% if logged_in_staff and not logged_in_staff.is_external %}
        <span class="small wam-hide-on-print"><a class="btn btn-sm btn-secondary ms-1" role="button" href="{% url 'module_staff_allocation' package.id module.id %}">Edit</a></span>
        {% endif %}
    </p>
    {% endif %}
</div>

<div class="mt-5">
    <h5 class="mt-3">Custom activities</h5>
    {% if activities %}
        <div class="table-responsive small mt-2 mb-2">
            <table class="table table-striped table-hover w-100">
                <tr>
                    <th scope="col">Activity name</th>
                    <th scope="col">Staff member</th>
                    <th scope="col">Comment</th>
                </tr>
                {% for activity in activities %}
                <tr>
                    <th>{{ activity.name }}</th>
                    <td>{{ activity.staff }}</td>
                    <td>{{ activity.comment }}</td>
                </tr>
                {% endfor %}
        </table>
        </div>
    {% else %}
        <p class="text-info-emphasis">No custom activities recorded for this module.</p>
    {% endif %}
</div>

<div class="mt-5">
    <h5>Assessment resources</h5>
    {% if assessment_signoffs.0.assessment_state.next_states_guidance %}
    <p class="text-info-emphasis">
        {{ assessment_signoffs.0.assessment_state.next_states_guidance|safe }}
    </p>
    {%  else %}
    <p class="fst-italic">
        Please upload assessment items below, and sign them off when satisfied.
    </p>
    {% endif %}

    {% if unsigned_items %}
    <p class="p-2 rounded-3 text-bg-info">
        These are some items that are not yet "signed-off". They can be deleted, or added to until they are signed off.<br/>
        Please note that these items are not considered final, but rather as in draft until they are signed off.
    </p>
    {% endif %}
    <p class="wam-hide-on-print">
        <a class="link-opacity-50-hover link-underline-opacity-50 link-offset-2" href="{% url 'add_assessment_resource' module.id %}">add assessment resource</a> |
        <a class="link-opacity-50-hover link-underline-opacity-50 link-offset-2" href="{% url 'add_assessment_sign_off' module.id %}">sign off resources</a>
    </p>

{% if assessment_history %}
    {% for signoff, resources in assessment_history %}
    <div class="card mt-4 px-3 pt-3 border border-secondary rounded-3">

    {% if signoff %}
        <div class="row">
            <div class="col-6 small">
                <span class="text-info-emphasis fw-bold">{{ signoff.assessment_state }}</span>
                <br/>
                <span class="text-secondary-emphasis" title="{{ signoff.created }}">[{{ signoff.created|date:"SHORT_DATETIME_FORMAT" }}]</span>
            </div>
            <div class="col-4 text-info-emphasis small">
                {% if signoff.signed_by.first_name or signoff.signed_by.last_name %}
                    by {{ signoff.signed_by.first_name }} {{ signoff.signed_by.last_name }}
                {% endif %}
            </div>
            {# if forloop.first #}
            {# This won't work since we may have a resource without signoff #}
            <div class="col-2 wam-hide-on-print p-0 pe-2 text-end">
                <a class="btn btn-sm btn-warning" role="button" href="{% url 'delete_assessment_sign_off' signoff.id %}">
                    delete
                </a>
            </div>
            {# endif #}
        </div>
        <div class="row pt-3 pb-2">
            <div class="col-12 small">
                {{ signoff.notes }}
            </div>
        </div>
    {% endif %}

    {% if resources %}
        <div class="row">
            <div class="col-12 p-0">
                <div class="table-responsive small mt-3 mb-2">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col" class="w-25">Resource type</th>
                                <th scope="col" class="w-25">Name</th>
                                <th scope="col">Owner</th>
                                <th scope="col">Created</th>
                                <th scope="col" class="wam-hide-on-print">View</th>
                                <th scope="col" class="wam-hide-on-print">Delete</th>
                            </tr>
                        </thead>
                        <tbody class="table-group-divider">
                            {% for resource in resources %}
                            <tr>
                                <td class="w-25">{{ resource.resource_type }}</td>
                                <td class="w-25">{{ resource.name }}</td>
                                <td>{{ resource.owner }}</td>
                                <td><span title="{{ resource.created }}">{{ resource.created|date:"SHORT_DATETIME_FORMAT" }}</span></td>
                                <td class="wam-hide-on-print"><a class="link-opacity-50-hover link-underline-opacity-50 link-offset-2" href="{% url 'download_assessment_resource' resource.id %}">View</a></td>
                                <td class="wam-hide-on-print"><a class="link-opacity-50-hover link-underline-opacity-50 link-offset-2" href="{% url 'delete_assessment_resource' resource.id %}">Delete</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    </div>
    {% endfor %}

{% else %}
    <div class="text-info-emphasis">
        No assessment resources recorded for this module.
    </div>

{% endif %}
</div>

{% endblock content %}

{% extends "loads/base_automatic.html" %} {% block content %}

{% load static %}
{# <!-- Include formset plugin - including jQuery dependency -->                      #}
{# <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> #}
{# <script src="{% static 'loads/persist-headers.js' %}"></script>                    #}

<link rel="stylesheet" type="text/css" href="{% static 'loads/load_charts.css' %}" />

<p class="mb-4">
    Selected year:<br/>
    <span class="font-monospace fw-bold me-2">{{package}}</span> <a class="btn btn-secondary btn-sm" href="{%url 'workpackage_change' %}">Change year</a>
</p>

<!-- Style Colours from WAM configuration -->
<style>
    {% for category in categories %}
    .bg-col{{ category.pk }} {
        background-color: {{ category.colour }};
    }
    {% endfor %}
</style>

{% if package.draft or package.in_the_future or package.in_the_past %}
<div class="border border-2 border-danger p-3 rounded-3 mb-4">
    <h6 class="fw-bold">!! Please note these exceptions <i class="fw-normal small">(hover for more information)</i></h6>
    <div class="d-flex">
        {% if package.draft %}
        <div class="badge text-bg-danger me-2"
             title="This is a DRAFT allocation and may be incomplete.">Draft allocation</div>
        {% endif %}
        {% if package.in_the_past %}
        <div class="badge text-bg-danger me-2"
             title="The currently selected Work Package is in the Past! You probably want to change the year above.">Past work package</div>
        {% endif %}
        {% if package.in_the_future %}
        <div class="badge text-bg-danger me-2"
             title="The currently selected Work Package is in the Future">Future work package</div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if group_data %}
    {% for group, group_list, group_total, group_average, group_allocated_staff, group_allocated_average in group_data %}
    <div class="container bg-white p-5 shadow rounded">
        <h3>
            {{group}}
        </h3>
        {% if group_list %}
        <div id="chart-container">
            {% for staff, loads_by_category, hours, bar_width, scaled_hours in group_list %}
            <!-- Start a row -->
            <div class="chart-row">
                <div class="chart-label">{{ staff }}</div>
                <div class="progress-wrapper">
                    <div class="hundred-percent-marker"></div>
                    <div class="progress" style="width: {{ bar_width }}%;">
                        {% for category, hours, percentage in loads_by_category %}
                        <!-- Start a Block -->
                        <div class="progress-bar bg-col{{ category.pk }}" role="progressbar" style="width: {{ percentage }}%">
                            <span class="font-monospace" data-toggle="tooltip" title="{{ category.abbreviation }}: {{ hours|floatformat:0 }} Hours">
                                {{ percentage|floatformat:0 }}%
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="alert alert-info small">
            <strong>Legend:</strong> The red dashed line represents 100% capacity, taking into account staff FTE. Hovering on percentages shows underlying hours. Grey areas are unallocated. Over allocations past 125% are scaled down to fit.
            <div class="mt-3 small">Categories:
                <div class="mt-2 legend_wrapper">
                    {% for category in categories %}
                        <div class="legend_box bg-col{{ category.pk }}"></div>&nbsp;{{ category }}&nbsp;&nbsp;
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="mt-3">
            Total hours for all activities in this group is {{ group_total }}, with
            average hours per staff member is
            {{ group_average|stringformat:".0f" }}, for allocated staff only the average hours per staff member is
            {{ group_allocated_average|stringformat:".0f" }}.
        </div>
    </div>
    {% else %}
    <p>
        No allocations for this group at this time
    </p>
    {% endif %}
    {% endfor %}
    <h3 class="mt-4">
        Overall totals
    </h3>
    <p>
        Total hours for all activities is {{ total }}, average hours by staff member {{ average|stringformat:".0f" }}.
    </p>

{% else %}
    <p>
        No data for this work package at this time
    </p>
{% endif %}

{% endblock content %}